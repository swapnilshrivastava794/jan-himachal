{% load static %}

<!-- ‚úÖ Fixed Transparent Header -->
<header class="top-overlay-header position-fixed w-100" style="top:0; left:0; z-index:100;">
  <div class="container-fluid d-flex align-items-center justify-content-between py-2 px-3">

    <!-- ‚ò∞ Left: Menu Icon -->
    <div class="fs-4" onclick="toggleMenu()">
      <i class="fas fa-bars"></i>
    </div>

    <!-- üè† Center: Logo -->
    <div class="position-absolute top-50 start-50 translate-middle text-center">
      <a href="/" class="d-inline-block">
        <img src="{{ profile_setting.logo_dark.url }}" alt="Logo" class="img-fluid" style="height:40px;">
      </a>
    </div>

    <!-- üîç Right: Icons -->
    <div class="d-flex align-items-center gap-3 ms-auto fs-5">
       <a href="/auth/sign-in" class=" d-flex align-items-center gap-1">
          <i class="bi bi-box-arrow-in-right"></i>
        </a>
      <div id="mobile-search-icon" role="button">
        <i class="bi bi-search"></i>
      </div>
      <div data-bs-toggle="modal" data-bs-target="#ModalSubscribe" role="button">
        <i class="bi bi-bell-fill"></i>
      </div>
    </div>
  </div>
</header>

{% include 'subscribe_model.html' %}

<!-- ‚úÖ SIDE MENU -->
<div class="sidenav-black-overlay" onclick="closeMenu()"></div>
<div class="side-menu" id="sideMenu">
  <div class="menu-back" onclick="closeMenu()">&larr; Back</div>

  <div class="menu-item" onclick="showSubmenu('submenu')">
    <i class="fas fa-list"></i> All Categories 
    <i class="fas fa-chevron-right float-end"></i>
  </div>

  <div id="submenu" class="submenu">
    <div class="menu-back" onclick="closeMenu()">&larr; Back</div>
    {% for link in Blogcat %}
      <div class="menu-item" onclick="showSubmenu('submenu-{{ link.id }}')">
        {{ link.cat_name }} <i class="fas fa-chevron-right float-end"></i>
      </div>
    {% endfor %}
  </div>

  {% for link in Blogcat %}
    <div id="submenu-{{ link.id }}" class="thirdmenu">
      <div class="menu-back" onclick="hideSubmenu('submenu-{{ link.id }}')">&larr; Back</div>
      {% for sublink in link.sub_category_set.all %}
        {% if sublink.subcat_status == 'active' %}
          <div class="menu-item">
            <a href="/{{ link.cat_slug }}/{{ sublink.subcat_slug }}">{{ sublink.subcat_name }}</a>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endfor %}

  <div class="menu-item">
    <a href="{% url 'contact-us' %}">Contact Us</a>
  </div>

  {% for page in pages %}
    <div class="menu-item">
      <a href="{% url 'cms' page.slug %}">{{ page.pagename }}</a>
    </div>
  {% endfor %}
</div>

<!-- ‚úÖ dxb-STYLE SEARCH OVERLAY -->
<div id="mobile-search-panel" class="dxb-search-overlay">
  <div class="dxb-search-box">
    <div class="d-flex align-items-center mb-3">
      <i class="bi bi-search me-2 fs-5 text-muted"></i>
     <form action="{% url 'search' %}" method="get" class="w-100 position-relative">
        <input 
          type="text" 
          id="searchInput"
          name="title" 
          class="form-control border-0 shadow-none" 
          placeholder="Search the web..." 
          autocomplete="off"
          required autofocus>

        <!-- üîΩ Suggestions -->
        <ul id="suggestions" 
            class="list-group position-absolute w-100 shadow-sm" 
            style="z-index:1000; display:none; max-height:250px; overflow-y:auto;">
        </ul>
      </form>
      <i id="closeSearch" class="bi bi-x-lg fs-5 text-muted" style="cursor:pointer;"></i>
    </div>

    <div class="divider mb-2"></div>

  <div class="recent-searches">
  <p class="text-muted small mb-2">Recent Searches</p>
  <ul class="list-unstyled" id="recentSearchList">
    {% if request.session.recent_searches %}
      {% for term in request.session.recent_searches %}
        <li class="recent-item" style="cursor:pointer;">
          <i class="bi bi-clock me-1"></i> {{ term }}
        </li>
      {% endfor %}
    {% else %}
      <li class="text-muted small">No recent searches</li>
    {% endif %}
  </ul>
</div>
  </div>
</div>

<!-- ‚úÖ JS -->
<script src="{% static 'js/jquery.min.js' %}"></script>
<script src="{% static 'js/owl.carousel.min.js' %}"></script>

<script>
  function toggleMenu() {
    document.getElementById("sideMenu").classList.add("active");
    document.querySelector(".sidenav-black-overlay").style.display = "block";
  }

  function closeMenu() {
    document.getElementById("sideMenu").classList.remove("active");
    document.querySelector(".sidenav-black-overlay").style.display = "none";
  }

  function showSubmenu(id) {
    document.querySelectorAll('.submenu, .thirdmenu').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  function hideSubmenu(id) {
    document.getElementById(id).classList.remove('active');
  }

  // üîç dxb-style Search Logic
  document.addEventListener("DOMContentLoaded", function() {
    const searchIcon = document.getElementById('mobile-search-icon');
    const searchPanel = document.getElementById('mobile-search-panel');
    const closeSearch = document.getElementById('closeSearch');

    if (searchIcon && searchPanel && closeSearch) {
      searchIcon.addEventListener('click', () => {
        searchPanel.classList.add('active');
        const input = document.querySelector('.dxb-search-box input');
        if (input) input.focus();
      });

      closeSearch.addEventListener('click', () => {
        searchPanel.classList.remove('active');
      });
    }
  });

  // üß† jQuery Search Suggestions + Recent
  $(document).ready(function() {

    // üß† Live Suggestions via existing search URL
    $("#searchInput").on("keyup", function() {
      const query = $(this).val().trim();
      if (query.length > 1) {
        $.get("{% url 'search' %}", { title: query, ajax: 1 }, function(data) {
          if (data.results && data.results.length > 0) {
            let list = "";
            data.results.forEach(item => {
              list += `<li class="list-group-item suggestion-item" style="cursor:pointer;">${item}</li>`;
            });
            $("#suggestions").html(list).show();
          } else {
            $("#suggestions").html('<li class="bg-white p-2">No results</li>').show();
          }
        }).fail(function() {
          $("#suggestions").hide();
        });
      } else {
        $("#suggestions").hide();
      }
    });

    // üñ±Ô∏è Click on suggestion ‚Üí fill input
    $(document).on("click", ".suggestion-item", function() {
      $("#searchInput").val($(this).text());
      $("#suggestions").hide();
    });

    // üïì Click on recent search ‚Üí fill input
    $(document).on("click", ".recent-item", function() {
      $("#searchInput").val($(this).text());
      $("#searchInput").focus();
    });

    // üö´ Hide suggestions on outside click
    $(document).click(function(e) {
      if (!$(e.target).closest("#searchInput, #suggestions").length) {
        $("#suggestions").hide();
      }
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const searchIcon = document.getElementById('mobile-search-icon');
    const searchPanel = document.getElementById('mobile-search-panel');
    const closeSearch = document.getElementById('closeSearch');
    const searchInput = document.getElementById('searchInput');
    const suggestions = document.getElementById('suggestions');
    const recentList = document.getElementById('recentSearchList');

    // üß† LocalStorage: Recent Searches
    function getRecentSearches() {
      return JSON.parse(localStorage.getItem('recentSearches') || '[]');
    }

    function saveRecentSearch(query) {
      if (!query) return;
      let recents = getRecentSearches().filter(item => item.toLowerCase() !== query.toLowerCase());
      recents.unshift(query);
      if (recents.length > 5) recents = recents.slice(0, 5);
      localStorage.setItem('recentSearches', JSON.stringify(recents));
    }

    function renderRecentSearches() {
      const recents = getRecentSearches();
      if (recents.length > 0) {
        recentList.innerHTML = recents.map(
          item => `<li class="recent-item" style="cursor:pointer;">
            <i class="bi bi-clock me-1"></i> ${item}
          </li>`
        ).join('');
      } else {
        recentList.innerHTML = `<li class="text-muted small">No recent searches</li>`;
      }
    }

    // üîç Toggle search overlay
    if (searchIcon && searchPanel && closeSearch) {
      searchIcon.addEventListener('click', () => {
        searchPanel.classList.add('active');
        renderRecentSearches();
        searchInput.focus();
      });

      closeSearch.addEventListener('click', () => {
        searchPanel.classList.remove('active');
      });
    }

    // üîé Live suggestions
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.trim();
      if (query.length < 2) {
        suggestions.style.display = 'none';
        return;
      }

      fetch(`/search-suggestions/?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          const list = data.suggestions || [];
          if (list.length > 0) {
            suggestions.innerHTML = list.map(
              item => `<li class="list-group-item suggestion-item" style="cursor:pointer;">
                <i class="bi bi-search text-muted me-2"></i>${item.title}
              </li>`
            ).join('');
            suggestions.style.display = 'block';
          } else {
            suggestions.innerHTML = `<li class="list-group-item text-muted">No results found</li>`;
            suggestions.style.display = 'block';
          }
        })
        .catch(() => (suggestions.style.display = 'none'));
    });

    // üñ±Ô∏è Click suggestion or recent item
    document.addEventListener('click', (e) => {
      if (e.target.closest('.suggestion-item')) {
        const text = e.target.closest('.suggestion-item').innerText.trim();
        saveRecentSearch(text);
        window.location.href = `{% url 'search' %}?title=${encodeURIComponent(text)}`;
      }
      if (e.target.closest('.recent-item')) {
        const text = e.target.closest('.recent-item').innerText.trim();
        saveRecentSearch(text);
        window.location.href = `{% url 'search' %}?title=${encodeURIComponent(text)}`;
      }
      if (!e.target.closest('#searchInput, #suggestions')) {
        suggestions.style.display = 'none';
      }
    });

    // ‚å®Ô∏è Press Enter
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (query) {
          saveRecentSearch(query);
          window.location.href = `{% url 'search' %}?title=${encodeURIComponent(query)}`;
        }
      }
    });
  });
</script>






